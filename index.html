<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Travel Buddy – Cultural Tips, Gems, Activities & Weather (Firefox Optimized)</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 20px; background: #f5f7fa; color: #333; }
    h1 { text-align: center; color: #1a73e8; }
    .container { max-width: 800px; margin: 0 auto; }
    .section { background: white; border-radius: 12px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
    input, select, button { padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ddd; }
    button { background: #1a73e8; color: white; border: none; cursor: pointer; }
    button:hover { background: #0d65d6; }
    .sign-in-btn { background: #34a853; padding: 14px 28px; font-size: 18px; margin: 15px auto; display: block; }
    .input-row { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; align-items: center; }
    .result { margin-top: 15px; line-height: 1.6; white-space: pre-wrap; }
    .loading { color: #777; font-style: italic; }
    .error { color: #d32f2f; font-weight: bold; background: #ffebee; padding: 12px; border-radius: 6px; }
    pre { background: #f8f9fa; padding: 12px; border-radius: 8px; overflow-x: auto; }
    .note, .firefox-note { font-size: 0.95em; color: #444; margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 6px; }
  </style>
</head>
<body>

<div class="container">
  <h1>Travel Buddy</h1>
  <p style="text-align:center; color:#555;">
    Powered by Puter.js • Works in Firefox (2026) • First use: Sign in via button below
  </p>

  <div class="firefox-note">
    <strong>Firefox users:</strong> If popup is blank/empty → 
    <ol style="margin:10px 0 0 20px;">
      <li>Open in Private Window (Ctrl+Shift+P) + disable extensions</li>
      <li>Go to about:preferences#privacy → Enhanced Tracking Protection → set to Standard (not Strict)</li>
      <li>Allow popups: Menu → Settings → Privacy & Security → Permissions → uncheck "Block pop-up windows"</li>
      <li>Manage Exceptions → add https://puter.com & https://api.puter.com → Allow</li>
      <li>Allow third-party cookies for puter.com if blocked</li>
    </ol>
    After fix → click "Sign In to Puter" below, then test.
  </div>

  <!-- Manual Sign-In Button (critical for Firefox) -->
  <button class="sign-in-btn" onclick="manualSignIn()">Sign In to Puter (Required First Time)</button>

  <!-- Quick Test Section -->
  <div class="section" style="background:#e8f0fe; border:1px solid #c3d6ff;">
    <strong>Quick LLM Test</strong>
    <div class="input-row">
      <input id="testPrompt" placeholder="e.g. Hello from Budapest – tell me a joke" style="flex:1;" />
      <select id="modelSelect">
        <option value="openai:gpt-4o-mini">GPT-4o mini (recommended – fast)</option>
        <option value="google:gemini-1.5-flash">Gemini 1.5 Flash</option>
        <option value="meta-llama:llama-3.1-70b-instruct">Llama 3.1 70B</option>
      </select>
      <button onclick="testLLM()">Test LLM</button>
    </div>
    <div id="testResult" class="result"></div>
    <div class="note">Open F12 → Console for debug. Network tab: look for puter.com requests (should be 200 OK).</div>
  </div>

  <!-- Cultural Tips -->
  <div class="section">
    <h2>Cultural Tips</h2>
    <div class="input-row">
      <input id="tipsLocation" placeholder="e.g., Japan, Budapest, New York" style="flex:1;" />
      <button onclick="getCulturalTips()">Get Tips</button>
    </div>
    <div id="tipsResult" class="result"></div>
  </div>

  <!-- Hidden Gems -->
  <div class="section">
    <h2>Hidden Gems</h2>
    <div class="input-row">
      <input id="gemsLocation" placeholder="e.g., Lisbon, Kyoto" style="flex:1;" />
      <button onclick="getHiddenGems()">Find Gems</button>
    </div>
    <div id="gemsResult" class="result"></div>
  </div>

  <!-- Activities -->
  <div class="section">
    <h2>Activities</h2>
    <div class="input-row">
      <input id="activitiesDest" placeholder="e.g., Barcelona, Bali" style="flex:1;" />
      <button onclick="getActivities()">Get Suggestions</button>
    </div>
    <div id="activitiesResult" class="result"></div>
  </div>

  <!-- Translation -->
  <div class="section">
    <h2>Quick Translator</h2>
    <div class="input-row">
      <input id="transText" placeholder="Text to translate" style="flex:1;" />
    </div>
    <div class="input-row">
      <input id="transLang" placeholder="Target language (e.g., Spanish, French)" style="flex:1;" />
      <button onclick="translateText()">Translate</button>
    </div>
    <div id="transResult" class="result"></div>
  </div>

  <!-- Weather -->
  <div class="section">
    <h2>Weather</h2>
    <div class="input-row">
      <input id="weatherCity" placeholder="City name (e.g., Paris, Tokyo)" style="flex:1;" />
      <button onclick="getWeather()">Check Weather</button>
    </div>
    <div id="weatherResult" class="result"></div>
  </div>
</div>

<script>
// ────────────────────────────────────────────────
// Manual Sign-In (Firefox-friendly – call explicitly)
// ────────────────────────────────────────────────
async function manualSignIn() {
  const statusEl = document.getElementById("testResult");
  statusEl.innerHTML = '<span class="loading">Opening Puter sign-in popup... Allow it!</span>';

  try {
    await puter.auth.signIn();  // Opens popup reliably
    statusEl.innerHTML = '<span style="color:green; font-weight:bold;">Signed in successfully! Now test any feature.</span>';
  } catch (err) {
    statusEl.innerHTML = `<div class="error">Sign-in popup issue: ${err.message || 'Blank/failed popup'}</div>
      <small>Firefox fix: Disable Enhanced Tracking Protection (set to Standard), allow popups for puter.com, try Private Window.</small>`;
    console.error('[SignIn Error]', err);
  }
}

// ────────────────────────────────────────────────
// Core AI call – with Firefox-tailored errors
// ────────────────────────────────────────────────
async function callAI(prompt, model = "openai:gpt-4o-mini") {
  try {
    const controller = new AbortController();
    setTimeout(() => controller.abort(), 30000);

    const response = await puter.ai.chat(prompt, { model, temperature: 0.6, max_tokens: 700 }, { signal: controller.signal });

    console.log('[DEBUG] Puter response:', JSON.stringify(response, null, 2));

    let content = response?.message?.content || response?.content || '';
    if (Array.isArray(content)) content = content.map(c => c.text || c).join('\n');
    if (typeof content !== 'string') content = JSON.stringify(content);

    return (content.trim() || '(empty – check console)') ;
  } catch (err) {
    console.error('[AI Error]', err);
    let msg = `Error: ${err.message || 'Failed'}`;
    if (err.name === 'AbortError') msg += ' (timeout – network/Puter issue)';
    if (err.message?.includes('popup') || err.message?.includes('auth')) {
      msg += '\nFirefox: Popup blank? → Set Tracking Protection to Standard + allow popups/cookies for puter.com';
    }
    return msg + '\n\nF12 → Console/Network for details.';
  }
}

// ────────────────────────────────────────────────
// Test LLM
// ────────────────────────────────────────────────
async function testLLM() {
  const prompt = document.getElementById("testPrompt").value.trim();
  const model = document.getElementById("modelSelect").value;
  const el = document.getElementById("testResult");

  if (!prompt) return alert("Enter a prompt");

  el.innerHTML = '<span class="loading">Checking sign-in & calling LLM...</span>';

  // Pre-check sign-in status
  try {
    if (puter.auth?.isSignedIn) {
      const signedIn = await puter.auth.isSignedIn();
      if (!signedIn) {
        el.innerHTML += '<br><strong>Not signed in yet → Click "Sign In to Puter" first!</strong>';
        return;
      }
    }
  } catch (e) {
    console.warn('[SignIn Check]', e);
  }

  const output = await callAI(prompt, model);
  el.innerHTML = `<pre>${output}</pre>`;
  if (output.includes('Error')) {
    el.innerHTML += '<br><button onclick="manualSignIn()">Sign In Now</button> <button onclick="testLLM()">Retry</button>';
  }
}

// ────────────────────────────────────────────────
// Other features (same logic)
// ────────────────────────────────────────────────

async function getCulturalTips() {
  const loc = document.getElementById("tipsLocation").value.trim();
  if (!loc) return alert("Enter location");
  const el = document.getElementById("tipsResult");
  el.innerHTML = '<span class="loading">Generating...</span>';
  const result = await callAI(`Provide 5 concise cultural tips for visitors to ${loc} in bullet point format. Be accurate and respectful.`);
  el.innerHTML = `<pre>${result}</pre>`;
}

async function getHiddenGems() {
  const loc = document.getElementById("gemsLocation").value.trim();
  if (!loc) return alert("Enter location");
  const el = document.getElementById("gemsResult");
  el.innerHTML = '<span class="loading">Finding...</span>';
  const result = await callAI(`List 5 hidden gems in ${loc} with brief descriptions in numbered format.`);
  el.innerHTML = `<pre>${result}</pre>`;
}

async function getActivities() {
  const dest = document.getElementById("activitiesDest").value.trim();
  if (!dest) return alert("Enter destination");
  const el = document.getElementById("activitiesResult");
  el.innerHTML = '<span class="loading">Suggesting...</span>';
  const result = await callAI(`Suggest 5–7 activities in ${dest} categorized as:\n- Outdoor\n- Cultural\n- Family-friendly\nUse headings and short descriptions.`);
  el.innerHTML = `<pre>${result}</pre>`;
}

async function translateText() {
  const text = document.getElementById("transText").value.trim();
  const lang = document.getElementById("transLang").value.trim();
  if (!text || !lang) return alert("Enter text + language");
  const el = document.getElementById("transResult");
  el.innerHTML = '<span class="loading">Translating...</span>';
  const result = await callAI(`Translate ONLY this to ${lang}:\n"""${text}"""\nOutput only translation.`, "google:gemini-1.5-flash");
  el.innerHTML = `<strong>Translation (${lang}):</strong><br><pre>${result}</pre>`;
}

async function getWeather() {
  const city = document.getElementById("weatherCity").value.trim();
  if (!city) return alert("Enter city");
  const el = document.getElementById("weatherResult");
  el.innerHTML = '<span class="loading">Fetching...</span>';
  const apiKey = "LABN5XZPTZ3RGLZCG4BGBMFHJ";
  const url = `https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline/${encodeURIComponent(city)}?key=${apiKey}&unitGroup=metric`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const current = data.currentConditions;
    const today = data.days[0];
    el.innerHTML = `
      <strong>${data.resolvedAddress}</strong><br>
      <em>${current.conditions}</em><br><br>
      Current: ${current.temp.toFixed(1)} °C (feels ${current.feelslike.toFixed(1)} °C)<br>
      Humidity: ${current.humidity}%<br>
      Wind: ${current.windspeed} km/h<br>
      Today max: ${today.tempmax.toFixed(1)} °C<br>
      <small>Timezone: ${data.timezone}</small>
    `;
  } catch (err) {
    el.innerHTML = `<div class="error">Weather error: ${err.message}</div>`;
  }
}
</script>
</body>
</html>
