<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Travel Buddy – Cultural Tips, Gems, Activities & Weather</title>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 20px; background: #f5f7fa; color: #333; }
    h1 { text-align: center; color: #1a73e8; }
    .container { max-width: 800px; margin: 0 auto; }
    .section { background: white; border-radius: 12px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
    input, select, button { padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ddd; }
    button { background: #1a73e8; color: white; border: none; cursor: pointer; }
    button:hover { background: #0d65d6; }
    .input-row { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; align-items: center; }
    .result { margin-top: 15px; line-height: 1.6; white-space: pre-wrap; }
    .loading { color: #777; font-style: italic; }
    .error { color: #d32f2f; font-weight: bold; background: #ffebee; padding: 10px; border-radius: 6px; }
    pre { background: #f8f9fa; padding: 12px; border-radius: 8px; overflow-x: auto; }
    .note { font-size: 0.9em; color: #555; margin-top: 8px; }
  </style>
</head>
<body>

<div class="container">
  <h1>Travel Buddy</h1>
  <p style="text-align:center; color:#555;">
    Powered by Puter.js • First AI call → sign-in popup (free @ puter.com) • Open F12 Console for debug info
  </p>

  <!-- Quick Test Section (use this first!) -->
  <div class="section" style="background:#e8f0fe; border:1px solid #c3d6ff;">
    <strong>Quick LLM Test (start here!)</strong>
    <div class="input-row">
      <input id="testPrompt" placeholder="e.g. Hello from Budapest – tell me a joke" style="flex:1;" />
      <select id="modelSelect">
        <option value="openai:gpt-4o-mini">GPT-4o mini (fast & cheap)</option>
        <option value="anthropic:claude-3-5-sonnet-latest">Claude 3.5 Sonnet</option>
        <option value="google:gemini-1.5-flash">Gemini 1.5 Flash</option>
        <option value="meta-llama:llama-3.1-8b-instruct">Llama 3.1 8B</option>
      </select>
      <button onclick="testLLM()">Test LLM</button>
    </div>
    <div id="testResult" class="result"></div>
    <div class="note">If stuck → check popup, disable ad-blocker, try incognito. See F12 → Console & Network tabs.</div>
  </div>

  <!-- Cultural Tips -->
  <div class="section">
    <h2>Cultural Tips</h2>
    <div class="input-row">
      <input id="tipsLocation" placeholder="e.g., Japan, Budapest, New York" style="flex:1;" />
      <button onclick="getCulturalTips()">Get Tips</button>
    </div>
    <div id="tipsResult" class="result"></div>
  </div>

  <!-- Hidden Gems -->
  <div class="section">
    <h2>Hidden Gems</h2>
    <div class="input-row">
      <input id="gemsLocation" placeholder="e.g., Lisbon, Kyoto" style="flex:1;" />
      <button onclick="getHiddenGems()">Find Gems</button>
    </div>
    <div id="gemsResult" class="result"></div>
  </div>

  <!-- Activities -->
  <div class="section">
    <h2>Activities</h2>
    <div class="input-row">
      <input id="activitiesDest" placeholder="e.g., Barcelona, Bali" style="flex:1;" />
      <button onclick="getActivities()">Get Suggestions</button>
    </div>
    <div id="activitiesResult" class="result"></div>
  </div>

  <!-- Translation -->
  <div class="section">
    <h2>Quick Translator</h2>
    <div class="input-row">
      <input id="transText" placeholder="Text to translate" style="flex:1;" />
    </div>
    <div class="input-row">
      <input id="transLang" placeholder="Target language (e.g., Spanish, French)" style="flex:1;" />
      <button onclick="translateText()">Translate</button>
    </div>
    <div id="transResult" class="result"></div>
  </div>

  <!-- Weather -->
  <div class="section">
    <h2>Weather</h2>
    <div class="input-row">
      <input id="weatherCity" placeholder="City name (e.g., Paris, Tokyo)" style="flex:1;" />
      <button onclick="getWeather()">Check Weather</button>
    </div>
    <div id="weatherResult" class="result"></div>
  </div>
</div>

<script>
// ────────────────────────────────────────────────
// Core AI call with timeout + robust parsing + debug
// ────────────────────────────────────────────────
async function callAI(prompt, model = "openai:gpt-4o-mini") {
  const resultEl = document.querySelector('.result') || { innerHTML: '' }; // fallback

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s max

    const response = await puter.ai.chat(prompt, {
      model,
      temperature: 0.6,
      max_tokens: 700
    }, { signal: controller.signal });

    clearTimeout(timeoutId);

    console.log('[DEBUG] Full Puter.ai response object:', JSON.stringify(response, null, 2));

    // Robust content extraction (covers docs + real variants)
    let content = '';
    if (response?.message?.content) {
      content = Array.isArray(response.message.content)
        ? response.message.content.map(c => typeof c === 'string' ? c : (c.text || '')).join('\n')
        : (typeof response.message.content === 'string' ? response.message.content : (response.message.content.text || ''));
    } else if (response?.content) {
      content = typeof response.content === 'string' ? response.content : (response.content.text || '');
    } else if (typeof response === 'string') {
      content = response;
    }

    const trimmed = (content || '(empty response)').trim();
    return trimmed || '(no content — see console for full response)';
  } catch (err) {
    console.error('[DEBUG] Puter.ai call failed:', err);
    let msg = `Error: ${err.message || 'Unknown issue'}`;
    if (err.name === 'AbortError') msg += '\n→ Timeout (30s) — network/Puter slow or blocked?';
    if (err.message?.includes('auth') || err.message?.includes('sign')) msg += '\n→ Sign-in popup blocked/dismissed? Try incognito.';
    return msg + '\n\nCheck F12 Console & Network tab (look for api.puter.com requests).';
  }
}

// ────────────────────────────────────────────────
// Test function with retry UI
// ────────────────────────────────────────────────
async function testLLM() {
  const prompt = document.getElementById("testPrompt").value.trim();
  const model = document.getElementById("modelSelect").value;
  const el = document.getElementById("testResult");

  if (!prompt) return alert("Enter a prompt");

  el.innerHTML = '<span class="loading">Calling LLM... (sign-in popup may appear first)</span>';

  const output = await callAI(prompt, model);
  el.innerHTML = `<pre>${output}</pre>`;
  if (output.includes('Error')) {
    el.innerHTML += '<br><button onclick="testLLM()">Retry Test</button>';
  }
}

// ────────────────────────────────────────────────
// Other features (same as yours, using fixed callAI)
// ────────────────────────────────────────────────

async function getCulturalTips() {
  const loc = document.getElementById("tipsLocation").value.trim();
  if (!loc) return alert("Enter a location");
  const el = document.getElementById("tipsResult");
  el.innerHTML = '<span class="loading">Generating tips...</span>';
  const prompt = `Provide 5 concise cultural tips for visitors to ${loc} in bullet point format. Be accurate and respectful.`;
  const result = await callAI(prompt);
  el.innerHTML = `<pre>${result}</pre>`;
}

async function getHiddenGems() {
  const loc = document.getElementById("gemsLocation").value.trim();
  if (!loc) return alert("Enter a location");
  const el = document.getElementById("gemsResult");
  el.innerHTML = '<span class="loading">Finding hidden gems...</span>';
  const prompt = `List 5 hidden gems / lesser-known attractions in ${loc} with brief descriptions in numbered format.`;
  const result = await callAI(prompt);
  el.innerHTML = `<pre>${result}</pre>`;
}

async function getActivities() {
  const dest = document.getElementById("activitiesDest").value.trim();
  if (!dest) return alert("Enter a destination");
  const el = document.getElementById("activitiesResult");
  el.innerHTML = '<span class="loading">Suggesting activities...</span>';
  const prompt = `Suggest 5–7 activities in ${dest} categorized as:\n- Outdoor\n- Cultural\n- Family-friendly\nUse clear headings and short descriptions.`;
  const result = await callAI(prompt);
  el.innerHTML = `<pre>${result}</pre>`;
}

async function translateText() {
  const text = document.getElementById("transText").value.trim();
  const lang = document.getElementById("transLang").value.trim();
  if (!text || !lang) return alert("Enter text and target language");
  const el = document.getElementById("transResult");
  el.innerHTML = '<span class="loading">Translating...</span>';
  const prompt = `Translate ONLY the following text to ${lang}. Preserve meaning and tone accurately.\nText: """${text}"""\nOutput only the translation.`;
  const result = await callAI(prompt, "google:gemini-1.5-flash");
  el.innerHTML = `<strong>Translation (${lang}):</strong><br><pre>${result}</pre>`;
}

async function getWeather() {
  const city = document.getElementById("weatherCity").value.trim();
  if (!city) return alert("Enter a city");
  const el = document.getElementById("weatherResult");
  el.innerHTML = '<span class="loading">Fetching weather...</span>';
  const apiKey = "LABN5XZPTZ3RGLZCG4BGBMFHJ";
  const url = `https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline/${encodeURIComponent(city)}?key=${apiKey}&unitGroup=metric`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const current = data.currentConditions;
    const today = data.days[0];
    const html = `
      <strong>${data.resolvedAddress}</strong><br>
      <em>${current.conditions}</em><br><br>
      Current: ${current.temp.toFixed(1)} °C (feels like ${current.feelslike.toFixed(1)} °C)<br>
      Humidity: ${current.humidity}%<br>
      Wind: ${current.windspeed} km/h<br>
      Today max: ${today.tempmax.toFixed(1)} °C<br>
      <small>Timezone: ${data.timezone}</small>
    `;
    el.innerHTML = html;
  } catch (err) {
    el.innerHTML = `<span class="error">Error: ${err.message || "Weather unavailable"}</span>`;
  }
}
</script>
</body>
</html>
