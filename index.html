<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Local AI Chat – WebLLM (Unlimited, No Key)</title>
  <script src="https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.48/dist/web-llm.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 20px; background: #0f0f17; color: #e0e0ff; }
    h1 { text-align: center; color: #a78bfa; }
    #chat { max-width: 800px; margin: 20px auto; height: 60vh; overflow-y: auto; padding: 16px; background: #1e1e2e; border-radius: 12px; }
    .message { margin: 12px 0; padding: 14px; border-radius: 16px; max-width: 85%; }
    .user { background: #7c3aed; color: white; margin-left: auto; }
    .assistant { background: #312e81; color: #e0e0ff; }
    form { max-width: 800px; margin: 20px auto; display: flex; gap: 10px; }
    input { flex: 1; padding: 16px; border-radius: 12px; border: none; background: #312e81; color: white; }
    button { padding: 16px 28px; background: #a78bfa; color: black; border: none; border-radius: 12px; cursor: pointer; }
    #status { text-align: center; color: #f472b6; margin: 12px 0; }
  </style>
</head>
<body>

<h1>Local AI Chat (WebLLM)</h1>
<p>First time downloads model (~2–4 GB) – then unlimited & offline</p>

<div id="chat">
  <div class="message assistant">Loading engine... Please wait (one-time setup).</div>
</div>

<div id="status">Initializing...</div>

<form id="form">
  <input id="input" placeholder="Ask anything..." disabled />
  <button type="submit" disabled>Send</button>
</form>

<script type="module">
  import { CreateMLCEngine } from "@mlc-ai/web-llm";

  const chat = document.getElementById('chat');
  const status = document.getElementById('status');
  const form = document.getElementById('form');
  const input = document.getElementById('input');
  const sendBtn = form.querySelector('button');

  let engine;

  async function init() {
    try {
      status.textContent = 'Downloading model (one-time, may take 2–10 min)...';
      engine = await CreateMLCEngine(
        "Phi-3.5-mini-instruct-q4f16_1-MLC",  // good balance of size & quality
        {
          initProgressCallback: (report) => {
            status.textContent = report.text;
          }
        }
      );
      status.textContent = 'Ready! Ask anything.';
      input.disabled = false;
      sendBtn.disabled = false;
    } catch (err) {
      status.textContent = `Error: ${err.message}`;
      console.error(err);
    }
  }

  init();

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text || !engine) return;

    const userMsg = document.createElement('div');
    userMsg.className = 'message user';
    userMsg.textContent = text;
    chat.appendChild(userMsg);
    chat.scrollTop = chat.scrollHeight;

    input.value = '';
    status.textContent = 'Generating...';

    try {
      const reply = await engine.chat.completions.create({
        messages: [{ role: "user", content: text }],
        temperature: 0.7,
        max_tokens: 512
      });

      const assistantMsg = document.createElement('div');
      assistantMsg.className = 'message assistant';
      assistantMsg.textContent = reply.choices[0].message.content;
      chat.appendChild(assistantMsg);
      chat.scrollTop = chat.scrollHeight;

      status.textContent = '';
    } catch (err) {
      status.textContent = `Error: ${err.message}`;
      console.error(err);
    }
  });
</script>
</body>
</html>
